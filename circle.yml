machine:
  services:
    - docker

dependencies:
  pre:
    - docker info && docker version

test:
  pre:
    - docker build -t polinux/httpd:circleci .

  override:
  # Start httpd
    - docker run -d -p 80:80 --name httpd polinux/httpd:circleci
    - docker logs -f httpd | tee -a ${CIRCLE_ARTIFACTS}/httpd.log:
          background: true
    - while true; do if grep "httpd entered RUNNING state" -a ${CIRCLE_ARTIFACTS}/httpd.log; then break; else sleep 1; fi done
    # Check connection on port 80
    - curl -sSLi --head http://127.0.0.1/ | grep "HTTP/1.1 200 OK"
